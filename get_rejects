#!/usr/bin/perl

# Script to extract errors recorded in files generated by the
# perfSONAR validation script.

use strict;
use warnings;

if ( !defined $ARGV[0] ) {
    print "Usage:\n";
    print "get-rejects validation-output-file\n";
    print "where validation-output-file is the name of a file\n";
    print "generated by the perfSONAR validation script.\n";
    print "Example:\n";
    print "get-rejects packet-retransmits-subintervals_psds-itb2_verify.log\n";
    print "\n";
    exit;
}

my $file    = $ARGV[0];
open( FH, "$file" );

my $output='';
my $term='';
my $reject_found=0;
my $die_reject_found=0;
while (<FH>) {
    if ( $_ =~ m/Started/ ) {
        #print "SS:  $_";
        $reject_found = 0;                 # Reset flag
        $output  = "_" x120;               # Reset $output
        $output .= "\n\n$_";
    }
    if ( $_ =~ m/verify/ ) {
        #print "VV: $_";
        $output .= "\n$_";                 # get the 'verify' line
        while (<FH>) {
            if ( $_ =~ m/rejected/ ) {
                #print "RR: $_";
                $reject_found = 1;
                $output .= "\n$_";         # get the 'rejected' line
                $_ = <FH>;
                #print "rr1: $_";
                $output .= "$_";           # and the next line
            }
            if ( $_ =~ m/Comparing/ ) {
                #print "CC: $_";
                while (<FH>) {
                    if ( $_ =~ m/Ended script/ ) {
                        #print "EE: $_";
                        $output .= "$_";
                        last;
                    }
                }
            }
            last if ( $_ =~ m/Ended script/ );
        }
    }
    if ( defined $_ && $_ =~ m/#### About to die/ ) {
        #print "AA: $_";
        $die_reject_found = 1;
        $term = "$_";
        while (<FH>) {
            if ( $_ =~ m/#### Terminated/ ) {
                #print "TT: $_";
                $term .= "$_";
                #$_ = <FH>;
                #print "tt1: $_";
                #$term .= "$_";
                last;
            } else {
                #print "tte: $_";
                $term .= "$_";
            }
        }
    }
    print "$term\n" if ( $die_reject_found && $_ =~ m/Terminated script/ );
    print "$output\n" if ( $reject_found && $_ =~ m/Ended script/ );
    $reject_found = 0;
    $die_reject_found = 0;
}
