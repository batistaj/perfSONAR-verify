#!/usr/bin/perl

# This script reports various record counts found in files
# generated by the perfSONAR data validation script.

# Usage:
# sum validation-log-file
# where validation-log-file is the name of a file generated
# by the validation script.

use strict;
use warnings;

my $fh=undef;
open($fh, "< $ARGV[0]") || die $!;

# Search for lines like the following and total results.
# Comparing 18013 records from the central store to 18044 records from perfSONAR hosts
my $csum=0;
my $rsum=0;
while (<$fh>) {
    if ( $_ =~ m/
           Comparing \s (\d+) \s
           records \s from \s the \s central \s store \s to \s
           (\d+)
           /xo ) {
        #print "-> $1\n";
        $csum+=$1;
        $rsum+=$2;
    } else {
        #chomp $_;
        #print "|$_|\n";
    }
}


# Rewind and find alteration count
seek $fh, 0, 0;

my $alt_sum=0;
while (<$fh>) {
    if ( $_ =~ m/Alteration/ ) {
        while (<$fh>) {
            $alt_sum+=1 if ( $_ =~ m/http/ );
            last if ( $_ =~ m/Validation/ );
        }
    }
}
$alt_sum = $alt_sum/2; # 2 records => 1 count


# Rewind and find validation count
seek $fh, 0, 0;

my $val_sum=0;
while (<$fh>) {
    if ( $_ =~ m/Validation/ ) {
        while (<$fh>) {
            $val_sum+=1 if ( $_ =~ m/http/ );
            last if ( $_ =~ m/Coverage/ );
        }
    }
}


# Rewind and find coverage count
seek $fh, 0, 0;

my $cov_sum=0;
while (<$fh>) {
    if ( $_ =~ m/Coverage/ ) {
        while (<$fh>) {
            $cov_sum+=1 if ( $_ =~ m/http/ );
            last if ( $_ =~ m/Ended/ );
        }
    }
}

print "totals from central: $csum from remotes: $rsum " .
      "alteration: $alt_sum validation: $val_sum coverage: $cov_sum\n";
close $fh;
